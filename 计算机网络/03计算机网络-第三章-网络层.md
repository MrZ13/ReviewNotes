[TOC]

# Chap3 网络层

## 3.0 本章目标

> - 了解网络层服务背后的原理
>   - 网络层服务模型
>   - 转发与寻路
>   - 路由器如何工作
>   - 寻路(路径选择)
>   - 规模的控制
>   - 新的主题:IPv6和流动性
> - 网络层相关的例子和实现



## 3.1 介绍

### 3.1.1 网络层简介

- 将报文段(Segment)从发送主机传输到接收主机
- 发送主机将报文段封装成数据包
- 在接收主机处，接收主机将数据报中的报文段交给传输层
- 网络层协议在每一个主机和路由器处生效
- 路由器检查每个经过它的IP数据包的头信息





### 3.1.2 网络层的主要功能

- 转发(范围较小)

  将packet从路由器的input处移动到合适的output处

- 寻路(范围较大)

  确定packet从发送处到接收处的路线



### 3.1.3 数据层与控制层

###### 数据层 Data Plane

> - 局部的，路由器的内部的功能
> - 决定datagram如何从路由器的输入端口转发到输出端口

![dBivgs.jpg](https://s1.ax1x.com/2020/08/23/dBivgs.jpg)



###### 控制层 Control Plane

> - 网络范围内的逻辑
> - 决定datagram如何选择合适的路由器，经过端到端的路径前往目的主机
> - 控制层的两种不同实现方式
>   - 传统的寻路算法
>     - 在路由器上实现
>   - 软件定义网络(Software-Defined networking)
>     - 在远程服务器上实现
>
> 
>
> **单一路由器控制层**
>
> ​	每个路由器上的路由算法组件在控制层上进行交互
>
> <img src="https://s1.ax1x.com/2020/08/23/dBAVn1.jpg" alt="dBAVn1.jpg" style="zoom:67%;" />
>
> 
>
> **逻辑集中控制层**
>
> 一个独特的远端控制器与路由器上的CA(Control Agents)进行交互，进行寻路
>
> <img src="https://s1.ax1x.com/2020/08/23/dBkz7V.jpg" alt="dBkz7V.jpg" style="zoom:67%;" />







### 3.1.4 网络层服务模型

网络层服务模型，即决定datagram如何从发送者传输到接收者的服务模型



##### 举例

###### 对于单一datagram的服务

> - 保证交付
> - 保证在一定时长内交付



###### 对于连续datagram流(datagram的有序序列)的服务

> - 有序交付
> - 保证流的最小带宽
> - ......

![dBepr9.jpg](https://s1.ax1x.com/2020/08/23/dBepr9.jpg)





## 3.2 虚拟电路与数据包网络

### 3.2.1 网络层提供的两种服务：无连接的/连接的服务

###### 虚拟电路

> 认为应该由网络层负责可靠的交互，提供有连接的服务



###### 数据包网络

> 网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务



Tips：网络层提供的服务与传输层有一定的相似之处，区别在于：

1. 端到端的(host to host)：从发送主机到接收主机
2. 无选择的：网络层选择一种提供方式，上层无法决定
3. 实现位置：在网络核心中实现



### 3.2.2 虚拟电路(Virtual Circuit)

> “从起点到终点的路径必须像电话线路一样(可靠)”



#### 3.2.2.1 特点与要求

- 可靠
- 在网络的传输沿着从起点到终点的路径
- 使用前要建立，使用后要销毁
- 每个packet都要携带vc identifier
- 每个路径上的路由器都维护相邻线路的状态
- 路由器的资源可能会被分配给VC





#### 3.2.2.2 虚拟电路的实现

###### 一条虚拟电路包括

> 1. 从起点到终点的道路
> 2. 虚电路编号(区分不同的虚拟电路)
>    - 在某一条虚拟电路上传输的packet需要持有这条虚拟电路的编号
>    - 每个虚拟电路的编号需要是不一样的
> 3. 在道路上每个路由器中持有的转发表
>    - 进入端口和来自哪条虚拟电路
>    - 离开端口和发往哪条虚拟电路



#### 3.2.2.3 转发表

![dBzqij.jpg](https://s1.ax1x.com/2020/08/24/dBzqij.jpg)



#### 3.2.2.4 虚拟电路的协议：Signaling Protocols

- 作用是进行VC的建立，维护和销毁
- 在ATM,frame-relay，X.25中被使用
- 如今已经很少使用



### 3.2.3 数据包网络(Datagram Network)

- 不需要在网络层建立链接
- 路由器不维护终端到终端链接的状态
  - 即不在网络层考虑链接的概念
- 根据目的主机的地址转发packet
  - 起始主机和目标主机相同的packet可能会经过不同的线路到达





### 3.2.4 为什么数据报网络在Internet中得到广泛使用

> 主要取决于Internet网络和终端的特点



###### Internet

> - 数据在计算机之间进行传递
>   - “有弹性的”，对时间的要求没有那么严格
> - 终端系统(计算机)是"聪明的"
>   - 可以进行控制，从错误中恢复
>   - 网络边缘处复杂，网络内部简单
> - 计算机之间的链接是多种多样的
>   - 不同的链接有不同的特点
>   - 难以提供统一的服务



###### ATM

> - 从电话技术中发展而来
> - 需要支持人们的通话
>   - 严格的时序要求(对延迟容忍度低)
>   - 需要有保障的服务
> - 终端系统是"愚蠢的"
>   - 无法提供多种多样的错误恢复或管理功能
>   - 网络内部复杂



### 3.2.5 虚拟电路网络和数据报网络的对比

![dB8Xj0.jpg](https://s1.ax1x.com/2020/08/23/dB8Xj0.jpg)





## 3.3 路由器内部有什么？

### 3.3.1 路由器的层级结构

<img src="https://s1.ax1x.com/2020/08/27/dh88DU.jpg" alt="dh88DU.jpg" style="zoom:67%;" />

路由器结构可以分为：

> - 控制层
>   - 核心构件是路由选择处理器
>   - 路由选择处理器根据特定的路由选择协议构造出路由表
> - 数据层(分组转发部分)
>   - 由三部分构成
>     - 交换结构
>     - 输入端口
>     - 输出端口
>   - 作用是根据转发表对分组进行处理，将分组从正确的端口转发出去





### 3.3.2 输入端口

#### 3.3.2.1 输入端口结构

[<img src="https://s1.ax1x.com/2020/08/27/dh8LPs.md.jpg" alt="dh8LPs.md.jpg" style="zoom: 67%;" />](https://imgchr.com/i/dh8LPs)



处理过程：

1. 物理层处理
2. 链路层处理
3. 网络层处理
   - “根据header部分的信息，在转发表中寻找输出端口，并将datagram转发到输出端口”



#### 3.3.2.2 最长前缀匹配

> 当在转发表中寻找记录时，根据与目的地址能够匹配的最长前缀来确定
>
> (前面数位可能是一样的)



### 3.3.3 交换结构

> **作用**
>
> 将packet从输入端口处的缓冲传输到输出端口处的缓冲
>
> **交换率(Switching Rate)**
>
> packets从输入端口转发到输出端口的速率



#### 3.3.3.1 通过内存交换

- 早期版本的路由器使用的交换结构
- 早期的路由器使用普通的计算机来实现，因此CPU就是计算机的CPU
- 先将packet复制到内存中，再由输出端口读取内存
- 如果存储器的带宽为M(每秒M个packet)，则交换率一定小于M/2
  - 因为存储器的读写速率是一个数量级上的



#### 3.3.3.2 通过总线交换

[![dht3W9.jpg](https://s1.ax1x.com/2020/08/27/dht3W9.jpg)](https://imgchr.com/i/dht3W9)

- packet通过共享的总线直接发送到输出端口
- 交换率被总线的速率限制，因为同一时间总线上只能传输一个packet



#### 3.3.3.3 通过互联网络交换

[![dhtdoD.jpg](https://s1.ax1x.com/2020/08/27/dhtdoD.jpg)](https://imgchr.com/i/dhtdoD)

- 对于N个输入和输出端口，有2N条总线
- 通过总线上节点的连接/断开，来决定一个输入端口能否和某个输出端口相连
- 同时只能由一个输入端口使用某一条垂直/水平总线



#### 3.3.3.4 输入端口处的排队现象

> 当交换率较低，而输入端口处packet到达的速度又较快时，就会造成排队，甚至是丢包



###### HOL blocking 现象(队首阻塞)

> 由于FIFO首先处理队首的元素，因此即使后续的元素对应端口是空闲的，如果队首元素没有出队，后续的元素仍然会被阻塞

[![dhNfnx.jpg](https://s1.ax1x.com/2020/08/27/dhNfnx.jpg)](https://imgchr.com/i/dhNfnx)



### 3.3.4 输出端口

#### 3.3.4.1 输出端口结构

[<img src="https://s1.ax1x.com/2020/08/27/dhNoND.jpg" alt="dhNoND.jpg" style="zoom:67%;" />](https://imgchr.com/i/dhNoND)



#### 3.3.4.2 输出端口处的排队

> 在交换结构传输给输出端口的packets过多，超过了buffer能够容纳的上限时，就会导致排队/丢包



### 3.3.5 Buffer(缓冲)

#### 3.3.5.1 缓冲区的大小

> 推荐值：$RTT * C / \sqrt{N}$
>
> RTT: Round Trip Time,TCP请求访问来回的时间
>
> C：带宽 e.g. 10Gbps
>
> N：流



#### 3.3.5.2 缓冲区队列的调度算法

- FIFO
- 优先级调度
- RR(时间片轮转)
- WFQ(Weighted Fair Queueing,加权公平排队)



## 3.4 IP:Internet Protocol

### 3.4.0 IP的介绍

#### 3.4.0.1 IP提供的服务

- IP协议为datagram在网络中的传输提供寻路功能

- IP协议确定一个datagram是否已经到达终点还是仍然需要进一步转发

- IP协议==不保证可靠传输==

- IP协议负责datagram的分片(fragmentation)

  - 一个datagram的大小不能超过网络的传输大小上线
  - 有些较大的datagrams因此需要被分片
  - 每个片段需要包含重新组装所需要的信息

  



#### 3.4.0.2 网络层的结构与IP

[<img src="https://s1.ax1x.com/2020/08/27/d4GMNQ.md.jpg" alt="d4GMNQ.md.jpg" style="zoom:67%;" />](https://imgchr.com/i/d4GMNQ)



[<img src="https://s1.ax1x.com/2020/08/27/d4GYuV.jpg" alt="d4GYuV.jpg" style="zoom: 67%;" />](https://imgchr.com/i/d4GYuV)



### 3.4.1 IPv4 Datagram格式

#### :fire:3.4.1.1 IPv4数据报的格式图解

> IPv4的地址长度为32bits，注意IP数据报长度!=IPv4地址长度

[![d4GIgI.jpg](https://s1.ax1x.com/2020/08/27/d4GIgI.jpg)](https://imgchr.com/i/d4GIgI)



##### 3.4.1.1.1 Header

###### 固定部分

> Header固定部分长度固定，始终为==20bytes==，与data部分的实际长度无关。从Version开始，到目的地址结束

1. 版本

   指IP协议的版本。v4 or v6

2. 首部长度

   4bits，x4以后即为首部的实际长度(单位为字节)，一般默认为0101(5)，即首部长度为20字节

3. 区分服务

   一般不适用此字段

4. 数据报总长度

   16bits，标识数据报的完整长度，最大可表示65535字节，实际上一般用不到

5. 标识

   16bits，每产生一个数据报，表示++，实际上是用于处理分片后的情况，标识字段相同的数据报需要最后组装到一起

6. 标志

   3bits,但实际上只有两位有效

   - 最低位： 1：后面还有分片 0：后面没有分片
   - 中间位：1：不允许分片 0：允许分片

7. 13位片偏移

   ==指出组装时，需要考虑的某片在原datagram中的位置==，片偏移以8个字节为单位

   e.g. 175: 175 x 8 = 1400，即这一片的数据部分首位实际上在原datagram的1400字节处

8. TTL

   数据报在网络中的寿命

9. 协议

   指出携带的数据是使用哪种协议的，以便IP协议正确地交给上层的协议

10. 首部检验和

    16bits，用于检验header部分经过网络上的传输是否出错

11. 源地址 32bits

12. 目的地址 32bits



###### 可变部分

> 可变部分的长度可以从1bytes到40bytes不等，可被用于排错，测量等多种用途。可变部分如果不是恰好是4字节的整数倍，则需要用全零的填充字段填满



##### 3.4.1.1.2 Data

==当提到Ip数据报的可变部分时，注意区分data部分和header中的可变部分(长度都不固定)==





#### 3.4.1.2 IP的分片与重组

每段网络链路的MTU是不一样的(MTU:Max Transfer Size),如果datagram超出MTU，就需要被分片



- 一个datagram会被拆分为小于等于MTU的多个datagram
- 所有datagrams在终点才被组装回来
- 每个datagram的header处都要携带关于分片的信息，以便后续的组装



#### 3.4.1.3 常用的IP路由操作命令

###### 1 winipcfg/ipconfig

> 显示当前计算机网络连接的情况，包括IP地址，子网掩码，网关......等信息



###### 2 .netset命令

> 显示当前计算机的网络状态，比如本机的路由表，每个协议的使用状态()TCP,UDP,IP,......)



### 3.4.2 IPv4 寻址

#### 3.4.2.1 数据流动过程的简介

- 在IP层抽象的互联网上只能看到IP数据报，图中的IP1→IP2 表示从源地址IP1 到目的地址IP2 ，两个路由器的IP地址并不出现在IP数据报的首部中
- 路由器只根据目的站的IP地址的网络号进行路由选择
- 在具体的物理网络的链路层，只能看见 MAC 帧而看不见 IP 数据报
- IP层抽象的互联网屏蔽了下层很复杂的细节，在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址，研究主机和主机或主机和路由器之间的通信



#### 3.4.2.2 IP寻址的介绍

###### IP地址

> 32位的标识码

###### Interface

> 将主机/路由器与物理链路连接起来的地方



Tips:IP地址与接口相对应，因此路由器可以有不止一个接口



#### 3.4.2.3 IP地址类型介绍(A-E)与分配

[![d4BOOJ.jpg](https://s1.ax1x.com/2020/08/27/d4BOOJ.jpg)](https://imgchr.com/i/d4BOOJ)

- 不同网络能够容纳的主机个数由hostid的位数决定
- IP地址的使用范围为(2^网络id^-1)，对于A类地址，由于127.0.0.1为回环测试地址，因此需要额外-1
- IP地址由InterNIC这一机构进行分配



#### :fire:3.4.2.4 IP地址的重要特点

> 1. IP地址是一种分等级的地址结构
> 2. 实际上的IP地址是标识一个主机/路由器与链路的接口
>    - 因此，如果一个主机连接到一个以上的网络上，则它必须持有相应数量的IP地址
> 3. 使用转发器或网桥连接起来的局域网仍然处于同一个网络中，因此netid是相同的
> 4. 一个netid对应的网络，有可能是范围很小的局域网，也有可能是覆盖很大地理范围的广域网。这个网络中的所有主机网络号部分是一致的
>    -  注意，网络号不仅包含netid，还包含netid之前，用于区分不同类型地址的几位数字



#### 3.4.2.5 IP层转发datagram的流程

###### 流程

> - 收到datagram
> - 根据header中的des-address查表
> - 转发给特定的接口或目的网络



##### 3.4.2.5.1 查找路由表

根据目的网络地址就能确定下一跳路由器，这样做的结果是：

- IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）。

- 只有到达最后一个路由器时，才试图向目的主机进行直接交付。



##### 3.4.2.5.2 特定主机路由

- 这种路由是为特定的目的主机指明一个路由。

- 采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。

e.g. 目的地址 50.123.45.1 --> 直接交付给xx路由





##### 3.4.2.5.3 默认路由

- 在目的网络不是表中的记录时，统一将datagram交给一个路由器
- 在一个网络只有很少的对外连接时很有用



Tips：

> - 需要注意的是，IP数据报的首部并没有位置指示下一跳路由器的IP地址/MAC地址
>
> - 根据下一跳的IP地址确定MAC地址，并发送datagram的功能由网络接口软件实现



##### :fire: 3.4.2.5.4 分组转发算法

(1)从数据报的首部提取目的主机的IP地址**D**, 得出目的网络地址为 **N**。

(2)若网络 **N**与此路由器直接相连，则把数据报直接交付目的主机**D**；否则是间接交付，执行(3)。

(3)若路由表中有目的地址为**D**的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。

(4) 若路由表中有到达网络**N**的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行(5)。

(5)若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)

(6)报告转发分组出错。





#### 3.4.2.6 IP子网寻址

##### 3.4.2.6.1 子网的背景

> - 在Internet发展的早期阶段，网络被视为是两层的
>   - 一，Internet整体
>   - 二，各个网络(具有相同网络号)
> - 然而，随着时间的发展，二级网络无法满足精细化的管理需求，三级结构的网络划分应运而生，即产生了子网的概念
> - 局部网络的结构
>   - 网络ID
>   - 子网ID
>   - 主机号
> - 在外层看来，共用一个网络号的各个子网是一个整体；在内部看来，不同的子网可以使用不同的路由策略



##### 3.4.2.6.2 二级IP地址与三级IP地址

[<img src="https://s1.ax1x.com/2020/08/27/d46A8P.jpg" alt="d46A8P.jpg" style="zoom:67%;" />](https://imgchr.com/i/d46A8P)





##### 3.4.2.6.3 子网的概念

- 子网内不同设备接口的子网部分相同
- 子网内部的不同设备可以在不使用路由器的情况下进行通信(物理层面上)

[![d46r26.jpg](https://s1.ax1x.com/2020/08/27/d46r26.jpg)](https://imgchr.com/i/d46r26)



##### :fire:3.4.2.6.4 子网与子网掩码

> 根据IP地址和子网掩码，可以快速确定网络地址
>
> (网络地址为地址分类+net-id+subnet-id，是从第一个字节第一位开始的)



###### 子网掩码的概念

子网掩码(subnet mask)又叫[网络掩码](https://baike.baidu.com/item/网络掩码/7862514)、[地址掩码](https://baike.baidu.com/item/地址掩码/8623995)、子网络遮罩，它是一种用来指明一个[IP地址](https://baike.baidu.com/item/IP地址)的哪些位标识的是[主机](https://baike.baidu.com/item/主机/455151)所在的子网，以及哪些位标识的是主机的位掩码



###### 子网掩码的特点(p105)

- 与网络相关的位统一置为1，剩余位置0
- 每个使用TCP/IP的网络都需要一个子网掩码，即使不进行子网划分
- 子网掩码往往用点分十进制来标识，而不是完整的二进制
  - 11111111......00000000 ×
  - 255.255.255.0 √



###### 子网掩码的重要作用

- 通过使用子网掩码，可以将网络号和主机号分开
- 使用子网掩码，同时可以向外部隐藏网络内部的细节



###### 子网掩码的重要属性

> - **子网掩码是一个网络或一个子网的重要属性。**
>
> - **路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。**
>
> - **路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。**
>
> - **若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。**



###### 默认子网掩码(和地址划分保持一致)

[<img src="https://s1.ax1x.com/2020/08/27/d4cRyT.jpg" alt="d4cRyT.jpg" style="zoom:67%;" />](https://imgchr.com/i/d4cRyT)





##### :fire:3.4.2.6.5 划分子网

###### 划分子网的步骤

> 确定以下四个问题的答案
>
> 1. 我需要借用多少位主机号
> 2. 子网掩码是多少
> 3. “魔法数字”是什么
> 4. 最开始的三个子网地址是什么



1.需要借用多少位主机号？

> 取决于子网中需要多少台主机
>
> 子网个数 = 2^借走的主机号位数^-2（首个地址保留，最后地址为广播地址）
>
> 主机个数 = 2^剩余主机号位数^-2



2.子网掩码的计算

> 将网络号部分置为1，每一个字节分别计算加和



3.“魔法数字”是什么

> ###### "魔法数"(实际上就是2^主机码位数^)
>
> 在确定首个子网的首个地址后，不断加上“魔法数”，即可获得其他子网的地址





##### :fire:3.4.2.6.6 使用子网时的分组转发

> 与不使用子网划分的情况的显著区别是
>
> - 路由表中增加一列子网掩码
> - 比较目的网络之前，先与子网掩码做AND运算
>
> 其他部分是一致的



(1) 从收到的分组的首部提取目的IP地址D。

(2) 先用各网络的子网掩码和D逐比特相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。

(3) 若路由表中有目的地址为*D*的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行(4)。

(4) 对路由表中的每一行的子网掩码和*D*逐比特相“与”，若其结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行(5)

(5) 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行(6)。

(6) 报告转发分组出错。





##### :fire: 3.4.2.7 获取IP地址

##### 3.4.2.7.1 硬编码与DHCP

###### 硬编码

由系统管理员确定，写死在文件中



###### DHCP

Dynamic Host Configuration Protocol,动态进行获取



##### 3.4.2.7.2 DHCP

###### 目标

> 使得主机能够在加入网络时，从服务器动态地获取它地IP地址

- 相当于"租赁"，如果一直使用，则可以不断延长租期
- 如果一段时间不用，就可以回收，提高了IP地址的利用率
- 更好地支持移动端的使用(不方便用硬编码)



###### 过程简介

1. 主机广播DHCP Discover信息
2. DHCP服务器发送DHCP Offer信息
3. 主机请求IP地址
4. DHCP应答，并提供IP地址



###### DHCP能够携带的其他信息

- client需要使用的第一跳路由器的地址
- DNS服务器的name和IP地址
- 网络掩码



### 3.4.3 Slowing IP Address Depletion

#### 3.4.3.1 可变长度子网掩码VLSM

> VLSM实际上就是多级的子网划分模式

[![d5SbOf.md.jpg](https://s1.ax1x.com/2020/08/27/d5SbOf.md.jpg)](https://imgchr.com/i/d5SbOf)





#### 3.4.3.2 无分类区域间路由选择CIDR

##### 3.4.3.2.1 背景

> Classless InterDomain Routing



使用CIDR，即是摒弃了地址分类，只用掩码位数来划分地址块。对于一个CIDR地址块，其写法为a.b.c.d/x。其中，x即为掩码的位数，比如x=20



##### 3.4.3.2.2 CIDR的特点/优点

> 通过使用CIDR，能够显著地降低路由表中记录的个数

e.g.

[![dII79S.md.jpg](https://s1.ax1x.com/2020/08/28/dII79S.md.jpg)](https://imgchr.com/i/dII79S)



> 使用CIDR，可以实现高效的路由信息通告，即使用单个网络前缀通告多个网络
>
> e.g.向网络前缀为a.b.c.d/xx的网络统一发送一条消息



##### 3.4.3.2.3 路由聚合

一个CIDR地址块可以表示很多个地址，因此这种地址的聚合又被称为路由聚合。这使得路由表中一个项目可以表示很多个原来的传统分类地址的路由



##### 3.4.3.2.4 构成超网

> 路由聚合也被称为构成超网
>
> - 前缀长度不超过23位的CIDR地址块都包含了多个C类地址(C类地址网络号部分为3+21=24位)，这些C类地址合起来就称为构成超网
> - CIDR地址块中的地址数一定是2的整数次幂





##### 3.4.3.2.5 最长前缀匹配

[![dIo3DA.md.jpg](https://s1.ax1x.com/2020/08/28/dIo3DA.md.jpg)](https://imgchr.com/i/dIo3DA)



#### 3.4.3.3 网络地址翻译NAT

> “多个拥有不同本地IP地址的主机共用一个全球IP地址”



###### 动机

> 解决外部发往内部的数据报不知道如何转发的问题：
>
> - 利用传输层的端口号区分内部的不同主机



###### 实现方式

> 1. 离开局域网的datagrams
>
>    使用同一个IP地址，依靠端口号区分不同主机
>
> 2. NAT 翻译表的记忆
>
>    把(本地IP地址，端口号)和(公网IP地址，端口号)保存在翻译表中
>
> 3. 前来局域网的datagrams
>
>    将发送到公网IP地址的datagram的dest更新为本地的IP地址



###### NAT的争议

> - 理论上，路由器应该只处理layer3相关信息
> - 违反了"端到端"传输的观点
> - IPv4地址不足的问题应该通过使用IPv6地址来解决
> - 所以NAT实际上是一种“奇技淫巧”



### 3.4.4 IPv6

#### 3.4.4.1 IPv6的背景

> 使用IPv6地址的动机
>
> 最开始的动机：IPv4的实在不够用了
>
> 后续的额外动机：
>
> - 通过优化header的格式，提高处理和转发的速度
> - 更改header以满足QoS的要求



#### :fire:3.4.4.2 IPv6的格式

- 首部长度为定长：40bytes()
- 不允许任何分片

[![dIX3kj.jpg](https://s1.ax1x.com/2020/08/28/dIX3kj.jpg)](https://imgchr.com/i/dIX3kj)

Priority：识别flow中不同datagrams的优先级

Flow Label：识别处于一个flow中的datagram

Next Header：识别高层的协议(向哪个传输层协议交付)



###### 相比于IPv4其他的变化

> - CheckSum：抛弃
> - Options：保留，但从header部分移除，由Next Header字段指定
> - ICMPv6：Internet Control Message Protocol v6,添加了一些新的功能
>   - 额外的消息类型，比如"packet过大"
>   - 多播组管理功能



#### 3.4.4.3 从IPv4到IPv6的迁移

> 由于不是所有路由器能够同时被升级，因此需要使IPv6数据报和IPv4数据报能够同时使用



隧道技术

> 将IPv6数据报包装成IPv4格式

[![dIxc3n.jpg](https://s1.ax1x.com/2020/08/28/dIxc3n.jpg)](https://imgchr.com/i/dIxc3n)



## 3.5 寻路协议 

### 3.5.1 寻路协议的目标

> 寻路协议的目的是找到“好”的路径，使得datagram能够从发送主机通过网络传输到目的主机
>
> - 路径：datagram需要经过的路由器的序列
> - "好"：“最短”，“最快”，“消耗最少”，“最不拥挤”......



### :fire:3.5.2 寻路协议的分类

#### 按照范围划分

###### 全局寻路算法

> 即“链接状态算法(Link State)”
>
> 所有的路由器都持有完整的网络拓扑结构和链路的权重



###### 去中心化寻路算法

> 即"距离向量算法(Distance Vector)"
>
> - 路由器知道物理相连的邻居和链路的权重
> - 通过迭代的方式和邻居交换信息



#### 按照静态/动态划分

###### 静态算法

> 路由信息随时间改变很少



###### 动态算法

> 路由信息改变更加敏捷
>
> - 定期更新
> - 对权重的变化及时响应



### 3.5.3 链接状态协议代表--Dijkstra

#### 3.5.3.1 Dijkstra算法的介绍

- 网络的拓扑结构和链路的权值被所有节点所知
  - 通过链路状态广播实现
  - 所有节点持有的信息相同
- 计算一个节点到其他节点的最短路径
- 迭代，知道所有节点之间的最优路径都已知

(具体的算法介绍略，详见数据结构部分的笔记)

#### 3.5.3.2 Dijkstra算法的讨论

###### 复杂度

> 假设有n个节点
>
> 每次需要检查不在已知集合的W个节点，因此总共需要n(n+1)/2次比较，时间复杂度为O(N^2^)



###### 震荡

> 由于某些链路的权值频繁变化，导致的路由算法得出结果频繁变化



### 3.5.4 距离向量协议代表--Bellman-Ford

#### 3.5.4.0 Bellman-Ford等式

d~x~(y) = Min{ c(x,v) + d~v~(y) , d~x~(y)} 

> - d~x~(y)：已知从节点x到节点y的最短距离
> - c(x,v)：节点x到节点v的直接距离



#### 3.5.4.1 基本思想

每个节点维护自己的距离向量，以及邻居节点的距离向量



#### 3.5.4.2 距离向量算法

##### 3.5.4.2.1 基本思想

> - 每个节点定期向其邻居节点发送自己的距离向量
> - 每当一个节点收到其它节点发来的距离向量时，它将判断是否需要更新自己的距离向量
>   - 具体方式是，把收到节点的距离向量中各项加上c(x,y)，然后再判断是否和现有的距离向量相比更小



##### 3.5.4.2.2 算法

1. 首先，每个节点向其他邻居节点发送自己的DV
2. 根据其他邻居节点发来的DV，判断是否需要更新自己的DV
3. 如果更新，则再次发送



##### 3.5.4.2.3 特点

> - 迭代，非同步的
>   - 每次迭代可能由局部的连接权重变化，或收到其他节点的距离向量更新消息而引发
> - 分布式的
>   - 每个节点只和它的邻居节点交换信息
> - 好消息传播快，坏消息传播慢





### 3.5.5 LS与DV算法的对比

###### 消息的复杂度

> Link State
>
> - 对于有n个节点，E条链接的链路，交换信息的次数为O(nE)
>
> Distance Vector
>
> - 仅与相邻节点交换距离向量信息



###### 收敛速度

> Link State
>
> - 收敛速度为O(N^2^)
>
> Distance Vector
>
> - 不确定



###### 鲁棒性

> 路由器故障时，会发生什么？
>
> Link State
>
> - 节点可能会发送错误的链路权值信息
> - 每个节点只计算自己的路由表
>
> Distance Vector
>
> - 节点可能会发送错误的路径权值信息
> - 每个节点的路由表也被(相邻的)其他节点使用





## 3.6 Internet中的寻路 

### 3.6.1 层次化的寻路

> 此前介绍的关于寻路的知识有两个前提：
>
> - 所有的路由器都是一样的
> - 网络是"扁平的"
>
> 而这些假设在现实中并不成立



##### 3.6.1.1 实际情况

1. Internet的范围很广，路由器无法存储所有的目的地址
2. 并不是所有机构都愿意交出网络的控制权



##### 3.6.1.2 实际解决方式

> 将路由器聚合起来，成为一个“自治系统(autonomous systems)”，再将路由分为“内部路由”和“外部路由”



###### 内部路由

> - 在同一个自治系统内进行路由
> - 所有的路由器必须运行相同的内部路由协议
> - 不同的自治系统可以使用完全不同的内部路由路由协议
> - 处于“边缘”位置的网关路由器，与其他自治系统相连接



###### 外部路由

> - 在不同的自治系统间进行路由
> - 网关路由器同时运行内部路由协议和外部路由协议



#### 3.6.1.3 Internet路由选择协议的基本知识

###### 理想的路由算法

> - 算法必须正确且完整
> - 算法应该是计算起来简单的
> - 算法需要能够适应通信量和网络拓扑的变化，即具有自适应性
> - 算法应具有稳定性
> - 算法应该是公平的
> - 算法应该是最佳的



###### “最佳路由”的概念

> - 不存在一种“完美的”路由算法
> - 实际的路由算法，应该尽可能趋近于完美
> - 路由选择仍然是一个非常复杂的问题



###### Internet中的两大路由选择协议

> 1. IGP 内部网关协议
>
>    即AS内部使用的路由协议，包括RIP,OSPF等
>
> 2. EGP 外部网关协议 
>
>    AS之间进行datagram的传递所需要的路由协议，现在最常用的是BGP-4协议





### 3.6.2 RIP(Routing Information Protocol) 

#### 3.6.2.1 RIP的工作原理

- RIP是一种分布式的基于==距离向量==的路由选择协议
- RIP协议要求每个路由器都维护从它自己到每一个目的网络的距离



#### 3.6.2.2 “最短距离”的定义

- 路由器到一个直接相连的网络：1
- 从一个路由器到不直接相连的网络：路由器个数+1



#### 3.6.2.3 RIP的特点

- RIP认为一个好的路由就是通过的路由器的==数目少==，即跳数少，而不考虑路径的权值信息
- RIP允许一条路径最多包含15个路由器，大于15则认为不可达。因此，RIP只是用于小的AS内使用
- RIP无法同时使用多条路由



#### 3.6.2.4 RIP协议的要点

- 仅和相邻的路由器交换信息
- 交换信息的内容是当前本路由器所知的所有信息，即路由表
- 按照固定的时间间隔交换路由信息



#### 3.6.2.5 使用RIP建立路由表

> - 路由器刚开始只知道和自己直接相连的网络
> - 随后和与自己相连的路由器交换信息，更新路由表
> - 经过若干次更新后，所有的路由器都会知道到达本自治系统中任意一个网络的最短距离和路径
> - RIP协议的收敛过程较快



[![d7YczF.jpg](https://s1.ax1x.com/2020/08/29/d7YczF.jpg)](https://imgchr.com/i/d7YczF)



#### 3.6.2.6 RIP的优缺点

###### 优点

> 1. 实现简单，开销小
> 2. 收敛速度较快



###### 缺点

> 1. 网络出现故障时，故障信息传播的速度较慢，即“坏消息传播慢”(RIP是基于DV算法的)
> 2. RIP限制了网络的规模



### 3.6.3 OSPF(Open Shortest Path First) 

#### 3.6.3.1 OSPF的基本特点

- OSPF使用链路状态算法(LS)
- 路由器会向AS内的其他节点广播链路状态
- IS-IS 路由协议与OSPF协议很相似



#### 3.6.3.2 OSPF的先进特性

- 安全性

  所有的OSPF信息都经过检验，从而可以避免恶意入侵

- 允许多个权重一样的路径

  RIP则不允许

- 对于每段链路，可以根据实际需要评估出不同的权重信息(比如根据时延/开销/可靠性/......)

- 支持多播



#### 3.6.3.3 OSPF的分层

将一个AS进一步细分为骨干部分和多个区域

[![d7Usit.jpg](https://s1.ax1x.com/2020/08/29/d7Usit.jpg)](https://imgchr.com/i/d7Usit)



- 区域边界路由器

  总结本区域中路由器的距离信息，并向其他区域边界路由器发送

- 骨干路由器

  骨干区域中的路由器，OSPF算法仅在骨干区域内运行

- 边界路由器

  与其他的AS连接



#### 3.6.3.4 OSPF的三个要点

- 向本自治系统中的所有路由器以==洪泛==的方式发送信息
- 发送的信息为本路由器所知的链路状态信息
- 只有链路状态发生变化时，才使用洪泛法发送信息



#### 3.6.3.5 OSPF--直接使用IP数据报

OSPF不使用TCP/UDP，而是直接以IP数据报的形式传送

- 由于OSPF的数据报很短，因此可以减少路由信息的通信量

- 由于长度很短，就避免了分片，因此可靠性得到提高(分片后，如果其中一个数据报出错，则整个原先的数据报都必须重传)

  

#### 3.6.3.6 OSPF的其他特点

- OSPF支持VLSM和CIDR
- 每个链路状态都会带上一个32bits的序号，序号越大则状态越新
- OSPF在链路状态改变/达到固定时长时，刷新链路状态信息
- OSPF没有“坏消息传播慢”的问题



### 3.6.4 BGP Border Gateway Protocol

#### 3.6.4.1 BGP的简介

BGP是AS间进行寻路的默认协议



BGP提供了：

- eBGP
  - 维护一个AS邻居AS内各个网络的可达性信息
- iBGP
  - 向AS内所有路由器发送可达性信息

[![d7D7WR.jpg](https://s1.ax1x.com/2020/08/29/d7D7WR.jpg)](https://imgchr.com/i/d7D7WR)



BGP允许子网向Internet发送自身的可达性信息("I'm here!")

#### 3.6.4.2 BGP session

两个使用BGP协议的路由器通过半永久的TCP连接进行信息的交互



##### 重要的路径属性

1. ###### AS-PATH

   AS的集合，即到达目标前缀网络所需要经过的AS

2. ###### NEXT-HOP

   指示到达下一跳AS所需要到达的边界路由器



#### 3.6.4.3 BGP的路径通告

1.边界路由器收到来自其他AS的eBGP通告

2.边界路由器向本AS内的内部路由器广播可达性信息

(可选)3.本AS的其他边界路由器向其他AS发送eBGP通告

[![d7vBvR.jpg](https://s1.ax1x.com/2020/08/29/d7vBvR.jpg)](https://imgchr.com/i/d7vBvR)

(在到达一个AS的路径不唯一时，需要根据某种评判标准选出其中一条路径)



#### 3.6.4.4 BGP的消息

BGP中的消息被用于在建立了TCP连接的路由器间进行消息的传递



###### BGP的四种消息类型

> 1. Open：建立TCP连接
> 2. Update：更新路径信息(DV)
> 3. KeepAlive：保持连接的打开
> 4. Notification：报告连接错误/关闭连接



#### 3.6.4.5 BGP和OSPF与转发表

> “AS内部的节点，通过iBGP知道想要发送给某一网络需要从发往哪个路由器，通过OSPF确定在AS内部前往这个路由器的方式”

[![d7xgLq.jpg](https://s1.ax1x.com/2020/08/29/d7xgLq.jpg)](https://imgchr.com/i/d7xgLq)



#### 3.6.4.6 BGP中的路径选择

> 在前往目的AS的路径不唯一时，可以根据以下几种度量方式来确定选择的路径：
>
> 1. 特殊的喜好
> 2. 最短的AS-PATH(经过AS最少)
> 3. 从本路由到达边界路由跳数最少(热土豆策略)
> 4. 其他的度量方式



#### 3.6.4.7 BGP中的可达性与通告(ISP隐藏可达性信息)

> 在很多情况下，ISP实际上知道可达性信息，但可能因为安全性/收费模式等原因，并不希望为其他客户服务，因此，可能不会发送可达性信息

[![d7OrKP.jpg](https://s1.ax1x.com/2020/08/29/d7OrKP.jpg)](https://imgchr.com/i/d7OrKP)

e.g.

A-->B&C：经过A可到达w

B --X-->C：经过B可到达A

因此，C只知道想到达A，必须从CA链路走



#### 3.6.4.8 BGP协议的特点

- BGP协议交换路由信息的节点数量级是AS的数量级，而不是具体网络的数量级
- 每个AS中的BGP边界路由器是很少的，因此AS间的路由选择不复杂
- BGP支持CIDR
- BGP刚刚开始运行时，交换的是整个BGP路由表，但随后只更新有变化的部分，从而节省了开销



### 3.6.5 为什么要区分内部与外部的路由？

###### 政策性原因

> 内部：admin希望能够控制路由算法，以及哪些路由器可以使用内部网络
>
> 外部：不需要政策性的决定



###### 范围

> 分层的路由协议能够避免路由表的规模过大，减少传输开销



###### 表现

> 内部：可以专注于选择表现好的路由算法
>
> 外部：可能需要考虑表现以外的其他因素



## 3.7 广播与多播寻路 

### 3.7.1 背景介绍

> 有时，需要向一组主机发送同样的数据，比如视频、音频、文字等



###### 不使用IP多播的情况

[![d75kX4.jpg](https://s1.ax1x.com/2020/08/29/d75kX4.jpg)](https://imgchr.com/i/d75kX4)



###### 使用IP多播的情况

[![d75mA1.jpg](https://s1.ax1x.com/2020/08/29/d75mA1.jpg)](https://imgchr.com/i/d75mA1)



### 3.7.2 多播简介

- 多播使用D类地址

  1 1 1 1 0 + 27bits

- 多播组使用的D类地址是永久的，由IANA负责指派

- 组成员是动态的

- 使用硬件进行多播



### 3.7.3 IP多播涉及的协议

###### IGMP 网际组管理协议

> 作用是使路由器知道多播组成员的信息
>
> - IGMP不是Internet范围上对所有多播组成员进行管理的协议
> - IGMP不知道一个IP多播组有哪些成员，也不知道这些成员在哪些网络上
> - IGMP的作用，是让本地局域网上的多播路由器知道LAN中是否有主机(上的进程)参加/退出了某个多播组



###### 多播路由选择协议

> 使得不同的多播路由器能够协同工作，以最小的代价将多播数据报传送给所有的组成员



## 3.8 Internet控制信息协议 

### 3.8.1 ICMP的简介

- ICMP被主机和路由器使用，来交流网络层次上的消息
- ICMP消息由IP数据报携带



### 3.8.2 ICMP与路由跟踪

###### 步骤

1. 发送主机连续发送一系列UDPsegment，第一个的TTL为1，第二个的TTL为2，......，依次递增
2. 第n个数据报到达第n个路由器时，TTL恰好清零，因此数据报被抛弃，然后此路由器向发送主机发送一个ICMP消息，包含此路由器的名称、IP地址等信息
3. 返回的ICMP消息到达时，发送主机计算RTT



### 3.8.3 ICMP的实用程序

###### Ping

> 功能 ： 测试两个主机之间的连通性
>
> - ping是应用层直接使用网络层ICMP的例子，它不涉及运输层的TCP或UDP



###### .tracert

> 功能：判定数据报到达目的主机所经过的路径，显示数据包经过的中继节点清单和到达时间





## 3.9 网络管理与SNMP

###### 背景

> 复杂的自治系统需要监视、控制等



###### 网络管理的概念

> 网络管理包括网络的部署、集成，以及软硬件间的协作,管理员进行的监视、测试、调查等，并通过控制网络和元素来达到特定的要



###### SNMP

> 简单网络管理协议（[SNMP](https://baike.baidu.com/item/SNMP/133378)） 是专门设计用于在 IP 网络管理[网络节点](https://baike.baidu.com/item/网络节点/9338583)（[服务器](https://baike.baidu.com/item/服务器/100571)、[工作站](https://baike.baidu.com/item/工作站/217955)、[路由器](https://baike.baidu.com/item/路由器/108294)、[交换机](https://baike.baidu.com/item/交换机/103532)及HUBS等）的一种标准协议，它是一种[应用层](https://baike.baidu.com/item/应用层)协议。