[TOC]

# Chap3 网络层

## 3.0 本章目标

> - 了解网络层服务背后的原理
>   - 网络层服务模型
>   - 转发与寻路
>   - 路由器如何工作
>   - 寻路(路径选择)
>   - 规模的控制
>   - 新的主题:IPv6和流动性
> - 网络层相关的例子和实现



## 3.1 介绍

### 3.1.1 网络层简介

- 将报文段(Segment)从发送主机传输到接收主机
- 发送主机将报文段封装成数据包
- 在接收主机处，接收主机将数据报中的报文段交给传输层
- 网络层协议在每一个主机和路由器处生效
- 路由器检查每个经过它的IP数据包的头信息





### 3.1.2 网络层的主要功能

- 转发(范围较小)

  将packet从路由器的input处移动到合适的output处

- 寻路(范围较大)

  确定packet从发送处到接收处的路线



### 3.1.3 数据层与控制层

###### 数据层 Data Plane

> - 局部的，路由器的内部的功能
> - 决定datagram如何从路由器的输入端口转发到输出端口

![dBivgs.jpg](https://s1.ax1x.com/2020/08/23/dBivgs.jpg)



###### 控制层 Control Plane

> - 网络范围内的逻辑
> - 决定datagram如何选择合适的路由器，经过端到端的路径前往目的主机
> - 控制层的两种不同实现方式
>   - 传统的寻路算法
>     - 在路由器上实现
>   - 软件定义网络(Software-Defined networking)
>     - 在远程服务器上实现
>
> 
>
> **单一路由器控制层**
>
> ​	每个路由器上的路由算法组件在控制层上进行交互
>
> <img src="https://s1.ax1x.com/2020/08/23/dBAVn1.jpg" alt="dBAVn1.jpg" style="zoom:67%;" />
>
> 
>
> **逻辑集中控制层**
>
> 一个独特的远端控制器与路由器上的CA(Control Agents)进行交互，进行寻路
>
> <img src="https://s1.ax1x.com/2020/08/23/dBkz7V.jpg" alt="dBkz7V.jpg" style="zoom:67%;" />







### 3.1.4 网络层服务模型

网络层服务模型，即决定datagram如何从发送者传输到接收者的服务模型



##### 举例

###### 对于单一datagram的服务

> - 保证交付
> - 保证在一定时长内交付



###### 对于连续datagram流(datagram的有序序列)的服务

> - 有序交付
> - 保证流的最小带宽
> - ......

![dBepr9.jpg](https://s1.ax1x.com/2020/08/23/dBepr9.jpg)





## 3.2 虚拟电路与数据包网络

### 3.2.1 网络层提供的两种服务：无连接的/连接的服务

###### 虚拟电路

> 认为应该由网络层负责可靠的交互，提供有连接的服务



###### 数据包网络

> 网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务



Tips：网络层提供的服务与传输层有一定的相似之处，区别在于：

1. 端到端的(host to host)：从发送主机到接收主机
2. 无选择的：网络层选择一种提供方式，上层无法决定
3. 实现位置：在网络核心中实现



### 3.2.2 虚拟电路(Virtual Circuit)

> “从起点到终点的路径必须像电话线路一样(可靠)”



#### 3.2.2.1 特点与要求

- 可靠
- 在网络的传输沿着从起点到终点的路径
- 使用前要建立，使用后要销毁
- 每个packet都要携带vc identifier
- 每个路径上的路由器都维护相邻线路的状态
- 路由器的资源可能会被分配给VC





#### 3.2.2.2 虚拟电路的实现

###### 一条虚拟电路包括

> 1. 从起点到终点的道路
> 2. 虚电路编号(区分不同的虚拟电路)
>    - 在某一条虚拟电路上传输的packet需要持有这条虚拟电路的编号
>    - 每个虚拟电路的编号需要是不一样的
> 3. 在道路上每个路由器中持有的转发表
>    - 进入端口和来自哪条虚拟电路
>    - 离开端口和发往哪条虚拟电路



#### 3.2.2.3 转发表

![dBzqij.jpg](https://s1.ax1x.com/2020/08/24/dBzqij.jpg)



#### 3.2.2.4 虚拟电路的协议：Signaling Protocols

- 作用是进行VC的建立，维护和销毁
- 在ATM,frame-relay，X.25中被使用
- 如今已经很少使用



### 3.2.3 数据包网络(Datagram Network)

- 不需要在网络层建立链接
- 路由器不维护终端到终端链接的状态
  - 即不在网络层考虑链接的概念
- 根据目的主机的地址转发packet
  - 起始主机和目标主机相同的packet可能会经过不同的线路到达





### 3.2.4 为什么数据报网络在Internet中得到广泛使用

> 主要取决于Internet网络和终端的特点



###### Internet

> - 数据在计算机之间进行传递
>   - “有弹性的”，对时间的要求没有那么严格
> - 终端系统(计算机)是"聪明的"
>   - 可以进行控制，从错误中恢复
>   - 网络边缘处复杂，网络内部简单
> - 计算机之间的链接是多种多样的
>   - 不同的链接有不同的特点
>   - 难以提供统一的服务



###### ATM

> - 从电话技术中发展而来
> - 需要支持人们的通话
>   - 严格的时序要求(对延迟容忍度低)
>   - 需要有保障的服务
> - 终端系统是"愚蠢的"
>   - 无法提供多种多样的错误恢复或管理功能
>   - 网络内部复杂



### 3.2.5 虚拟电路网络和数据报网络的对比

![dB8Xj0.jpg](https://s1.ax1x.com/2020/08/23/dB8Xj0.jpg)





## 3.3 路由器内部有什么？

### 3.3.1 路由器的层级结构

### 3.3.2 输入端口

#### 3.3.2.1 输入端口结构

#### 3.3.2.2 最长前缀匹配

### 3.3.3 交换结构

#### 3.3.3.1 通过内存交换

#### 3.3.3.2 通过总线交换

#### 3.3.3.3 通过互联网络交换

#### 3.3.3.4 输入端口处的排队现象

### 3.3.4 输出端口

#### 3.3.4.1 输出端口结构

#### 3.3.4.2 输出端口处的排队

### 3.3.5 Buffer(缓冲)

#### 3.3.5.1 缓冲区的大小

#### 3.3.5.2 缓冲区队列的调度算法



## 3.4 IP:Internet Protocol

### 3.4.0 IP的介绍

#### 3.4.0.1 IP提供的服务

#### 3.4.0.2 网络层的结构与IP



### 3.4.1 IPv4 Datagram格式

#### 3.4.1.1 IPv4数据报的格式图解

#### 3.4.1.2 IP的分片与重组

#### 3.4.1.3 IP数据报的校验和



#### 3.4.1.4 常用的IP路由操作命令

###### 1 winipcfg/ipconfig

###### 2 .netset命令



### 3.4.2 IPv4 寻址

#### 3.4.2.1 数据流动过程的简介

#### 3.4.2.2 IP寻址的介绍

#### 3.4.2.3 IP地址类型介绍(A-E)与分配

#### 3.4.2.4 IP地址的重要特点

#### 3.4.2.5 IP层转发datagram的流程

##### 3.4.2.5.1 查找路由表

##### 3.4.2.5.2 特定主机路由

##### 3.4.2.5.3 默认路由

##### :fire: 3.4.2.5.4 分组转发算法



#### 3.4.2.6 IP子网寻址

##### 3.4.2.6.1 子网的背景

##### 3.4.2.6.2 二级IP地址与三级IP地址

##### 3.4.2.6.3 子网的概念

##### :fire:3.4.2.6.4 子网与子网掩码

> 根据IP地址和子网掩码，可以快速确定网络地址
>
> (网络地址为地址分类+net-id，是从第一个字节第一位开始的)

###### 子网掩码的概念



###### 子网掩码的特点(p105)



###### 子网掩码的重要作用



##### :fire:3.4.2.6.5 划分子网

###### 划分子网的步骤



###### "魔法数"(实际上就是2^主机码位数^)



##### :fire:3.4.2.6.6 使用子网时的分组转发

> 与不使用子网划分的情况的显著区别是
>
> - 路由表中增加一列子网掩码
> - 比较目的网络之前，先与子网掩码做AND运算
>
> 其他部分是一致的



##### :fire: 3.4.2.7 获取IP地址

##### 3.4.2.7.1 硬编码与DHCP

##### 3.4.2.7.2 DHCP



### 3.4.3 Slowing IP Address Depletion

#### 3.4.3.1 可变长度子网掩码VLSM

> VLSM实际上就是多级的子网划分模式



#### 3.4.3.2 无分类区域间路由选择CIDR

##### 3.4.3.2.1 背景

##### 3.4.3.2.2 CIDR的特点/优点

##### 3.4.3.2.3 路由聚合

##### 3.4.3.2.4 构成超网

##### 3.4.3.2.5 最长前缀匹配



#### 3.4.3.3 网络地址翻译NAT

> “多个拥有不同本地IP地址的主机共用一个全球IP地址”



> 解决外部发往内部的数据报不知道如何转发的问题：
>
> - 利用传输层的端口号区分内部的不同主机





### 3.4.3 ICMP

### 3.4.4 IPv6

#### 3.4.4.1 IPv6的背景

#### :fire:3.4.4.2 IPv6的header格式

#### 3.4.4.3 从IPv4到IPv6的迁移



## 3.5 寻路协议 

### 3.5.1 寻路协议的目标

### :fire:3.5.2 寻路协议的分类

### 3.5.3 链接状态协议代表--Dijkstra

### 3.5.4 距离向量协议代表--Bellman-Ford

### 3.5.5 LS与DV算法的对比





## 3.6 Internet中的寻路 





## 3.7 广播与多播寻路 





## 3.8 Internet控制信息协议 







## 3.9 网络管理与SNMP

